import sys
from pathlib import Path
import pygame
import json

pygame.init()

clock = pygame.time.Clock()
FPS = 60

# Paths
ROOT = Path(__file__).resolve().parent.parent
ASSETS = ROOT / "assets" / "LevelEditor-main" / "LevelEditor-main" / "img"

# Background asset folder
BG_ASSETS = ASSETS / "Background"

# Tile asset folder
TILE_ASSETS = ASSETS / "tile"

# Background files
SKY = BG_ASSETS / "sky_cloud.png"
MOUNTAIN = BG_ASSETS / "mountain.png"
PINE1 = BG_ASSETS / "pine1.png"
PINE2 = BG_ASSETS / "pine2.png"

# Save/Load buttons (directly in img folder)
SAVE_BTN = ASSETS / "save_btn.png"
LOAD_BTN = ASSETS / "load_btn.png"

# Screen setup
SCREEN_WIDTH = 800
SCREEN_HEIGHT = 640
LOWER_MARGIN = 100
SIDE_MARGIN = 300

screen = pygame.display.set_mode(
    (SCREEN_WIDTH + SIDE_MARGIN, SCREEN_HEIGHT + LOWER_MARGIN)
)
pygame.display.set_caption("Level Editor")

# Colors
WHITE = (255, 255, 255)

# Game variables
ROWS = 16
MAX_COLS = 150
TILE_SIZE = SCREEN_HEIGHT // ROWS
TILE_TYPES = 20  # 20 tiles

scroll_left = False
scroll_right = False
scroll = 0
scroll_speed = 5

# Background images
sky_img = pygame.image.load(str(SKY)).convert_alpha()
mountain_img = pygame.image.load(str(MOUNTAIN)).convert_alpha()
pine1_img = pygame.image.load(str(PINE1)).convert_alpha()
pine2_img = pygame.image.load(str(PINE2)).convert_alpha()

# Tile images
img_list = []
for x in range(TILE_TYPES):
    tile_path = TILE_ASSETS / f"{x}.png"
    if not tile_path.is_file():
        raise FileNotFoundError(f"Missing tile: {tile_path}")
    img = pygame.image.load(str(tile_path)).convert_alpha()
    img = pygame.transform.scale(img, (TILE_SIZE, TILE_SIZE))
    img_list.append(img)

# Load Save/Load buttons
save_btn_img = pygame.image.load(str(SAVE_BTN)).convert_alpha()
save_btn_img = pygame.transform.scale(save_btn_img, (100, 50))
load_btn_img = pygame.image.load(str(LOAD_BTN)).convert_alpha()
load_btn_img = pygame.transform.scale(load_btn_img, (100, 50))

# ===================== CLASSES =====================
class TileButton:
    def __init__(self, image, x, y, size, index):
        self.image = pygame.transform.scale(image, (size, size))
        self.rect = pygame.Rect(x, y, size, size)
        self.index = index

    def draw(self, surface):
        surface.blit(self.image, self.rect.topleft)
        pygame.draw.rect(surface, WHITE, self.rect, 1)

    def is_clicked(self, pos):
        return self.rect.collidepoint(pos)

class Button:
    def __init__(self, image, x, y):
        self.image = image
        self.rect = pygame.Rect(x, y, image.get_width(), image.get_height())

    def draw(self, surface):
        surface.blit(self.image, self.rect.topleft)
        pygame.draw.rect(surface, WHITE, self.rect, 1)

    def is_clicked(self, pos):
        return self.rect.collidepoint(pos)

# ===================== TILE PALETTE 4x5 =====================
tile_buttons = []
button_size = 50
padding = 10
cols = 5
rows = 4

for i, img in enumerate(img_list):
    col = i % cols
    row = i // cols
    x = SCREEN_WIDTH + padding + col * (button_size + padding)
    y = padding + row * (button_size + padding)
    tile_buttons.append(TileButton(img, x, y, button_size, i))

selected_tile_index = None

# Placed tiles as (tile_index, grid_x, grid_y)
placed_tiles = []

# Save/Load buttons
save_button = Button(save_btn_img, SCREEN_WIDTH + 50, SCREEN_HEIGHT - 150)
load_button = Button(load_btn_img, SCREEN_WIDTH + 50, SCREEN_HEIGHT - 80)

# ===================== DRAW FUNCTIONS =====================
def draw_bg():
    for i in range(3):  # repeat background
        offset_x = (i * sky_img.get_width()) - scroll
        screen.blit(sky_img, (offset_x - scroll * 0.4, 0))
        screen.blit(
            mountain_img,
            (offset_x - scroll * 0.6, SCREEN_HEIGHT - mountain_img.get_height() - 260),
        )
        screen.blit(
            pine1_img,
            (offset_x - scroll * 0.7, SCREEN_HEIGHT - pine1_img.get_height() - 100),
        )
        screen.blit(
            pine2_img,
            (offset_x - scroll * 0.8, SCREEN_HEIGHT - pine2_img.get_height() + 20),
        )

def draw_grid():
    for c in range(MAX_COLS + 1):
        pygame.draw.line(
            screen, WHITE, (c * TILE_SIZE - scroll, 0), (c * TILE_SIZE - scroll, SCREEN_HEIGHT)
        )
    for r in range(ROWS + 1):
        pygame.draw.line(
            screen, WHITE, (0, r * TILE_SIZE), (SCREEN_WIDTH, r * TILE_SIZE)
        )

# ===================== MAIN LOOP =====================
run = True
while run:
    clock.tick(FPS)
    screen.fill((0, 0, 0))

    draw_bg()
    draw_grid()

    # Draw placed tiles
    for tile_index, x, y in placed_tiles:
        screen.blit(img_list[tile_index], (x * TILE_SIZE - scroll, y * TILE_SIZE))

    # Draw tile buttons
    for button in tile_buttons:
        button.draw(screen)

    # Draw Save/Load buttons
    save_button.draw(screen)
    load_button.draw(screen)

    # Draw selected tile following the mouse
    if selected_tile_index is not None:
        mouse_x, mouse_y = pygame.mouse.get_pos()
        if mouse_x < SCREEN_WIDTH:
            snap_x = (mouse_x // TILE_SIZE) * TILE_SIZE
            snap_y = (mouse_y // TILE_SIZE) * TILE_SIZE
            screen.blit(img_list[selected_tile_index], (snap_x, snap_y))
        else:
            screen.blit(img_list[selected_tile_index], (mouse_x - TILE_SIZE//2, mouse_y - TILE_SIZE//2))

    # Scroll map
    if scroll_left:
        scroll -= scroll_speed
    if scroll_right:
        scroll += scroll_speed
    scroll = max(0, min(scroll, (sky_img.get_width() * 3) - SCREEN_WIDTH))

    # Event handling
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            run = False

        # Keyboard
        if event.type == pygame.KEYDOWN:
            if event.key == pygame.K_LEFT:
                scroll_left = True
            if event.key == pygame.K_RIGHT:
                scroll_right = True
        if event.type == pygame.KEYUP:
            if event.key == pygame.K_LEFT:
                scroll_left = False
            if event.key == pygame.K_RIGHT:
                scroll_right = False

        # Mouse
        if event.type == pygame.MOUSEBUTTONDOWN:
            mouse_pos = pygame.mouse.get_pos()

            # Left click
            if event.button == 1:
                # Select tile
                for button in tile_buttons:
                    if button.is_clicked(mouse_pos):
                        selected_tile_index = button.index

                # Place tile
                if selected_tile_index is not None and mouse_pos[0] < SCREEN_WIDTH:
                    grid_x = (mouse_pos[0] + scroll) // TILE_SIZE
                    grid_y = mouse_pos[1] // TILE_SIZE
                    placed_tiles.append((selected_tile_index, grid_x, grid_y))

                # Save
                if save_button.is_clicked(mouse_pos):
                    with open("level.json", "w") as f:
                        json.dump(placed_tiles, f)
                    print("Level saved!")

                # Load
                if load_button.is_clicked(mouse_pos):
                    try:
                        with open("level.json", "r") as f:
                            loaded_tiles = json.load(f)
                            placed_tiles.clear()
                            for item in loaded_tiles:
                                placed_tiles.append(tuple(item))
                        print("Level loaded!")
                    except FileNotFoundError:
                        print("No saved level found.")

            # Right click: delete tile
            if event.button == 3 and mouse_pos[0] < SCREEN_WIDTH:
                grid_x = (mouse_pos[0] + scroll) // TILE_SIZE
                grid_y = mouse_pos[1] // TILE_SIZE
                placed_tiles = [
                    (t_index, x, y) for t_index, x, y in placed_tiles
                    if not (x == grid_x and y == grid_y)
                ]

    pygame.display.update()

pygame.quit()
